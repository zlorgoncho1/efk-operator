name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  manifests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install controller-gen
      run: |
        go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0
    
    - name: Generate manifests
      working-directory: ./efk
      run: |
        make manifests
    
    - name: Check for changes
      run: |
        git diff --exit-code || (echo "Manifests are out of date. Run 'make manifests' to update." && exit 1)

  generate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install controller-gen
      run: |
        go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0
    
    - name: Generate code
      working-directory: ./efk
      run: |
        make generate
    
    - name: Check for changes
      run: |
        git diff --exit-code || (echo "Generated code is out of date. Run 'make generate' to update." && exit 1)

  fmt:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Run go fmt
      working-directory: ./efk
      run: |
        make fmt
    
    - name: Check formatting
      run: |
        git diff --exit-code || (echo "Code is not formatted. Run 'make fmt' to fix." && exit 1)

  helm-lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.13.3'
    
    - name: Lint Elasticsearch chart
      working-directory: ./efk/helm-charts/efk-stack/elasticsearch
      run: |
        helm lint .
    
    - name: Lint Fluent Bit chart
      working-directory: ./efk/helm-charts/efk-stack/fluentbit
      run: |
        helm lint .
    
    - name: Lint Kibana chart
      working-directory: ./efk/helm-charts/efk-stack/kibana
      run: |
        helm lint .

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install dependencies
      working-directory: ./efk
      run: |
        go mod download
    
    - name: Run tests
      working-directory: ./efk
      run: |
        go test ./... -v -coverprofile=coverage.out
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./efk/coverage.out
        fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        working-directory: ./efk

  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Build operator binary
      working-directory: ./efk
      run: |
        go build -o bin/manager main.go
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      working-directory: ./efk
      run: |
        docker build -f docker/Dockerfile -t efk-operator:latest .

